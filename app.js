const state={allData:[],filteredData:[],selectedOrders:[],searchTerm:"",selectedFamily:"all",selectedSpecies:"all",startYear:1900,endYear:2024,minYear:1900,maxYear:2024,showUndated:!0,isPlaying:!1,playInterval:null,layers:{basemap:!0,observations:!0,reefs:!1,temperature:!1},map:null,baseLayer:null,markers:[],layerGroups:{observations:null,reefs:null,reefsFallback:null,temperature:null}};function getDepthColor(e){return e?e<20?"#3b82f6":e<50?"#8b5cf6":e<100?"#ec4899":"#ef4444":"#94a3b8"}async function fetchCoralData(){if(0===state.selectedOrders.length){console.warn("No coral types selected"),alert("Please select at least one coral type");return}try{console.log("=== FETCHING DATA ==="),console.log("Selected orders:",state.selectedOrders),document.getElementById("loading").classList.remove("hidden"),document.getElementById("app").classList.add("hidden");let e=Date.now(),t=state.selectedOrders.map(t=>{let a=`https://api.obis.org/v3/occurrence?scientificname=${encodeURIComponent(t)}&size=500&_t=${e}`;return console.log("Fetching URL:",a),fetch(a,{cache:"no-store"}).then(e=>(console.log(`HTTP ${e.status} for ${t}`),e.json()))}),a=await Promise.all(t);state.allData=[],a.forEach((e,t)=>{let a=e.results?.length||0;console.log(`${state.selectedOrders[t]}: ${a} records`),e.results&&(state.allData=state.allData.concat(e.results))}),console.log(`TOTAL: ${state.allData.length} records`),console.log("===================");let l=state.allData.map(e=>e.date_year).filter(Boolean);l.length>0&&(state.minYear=Math.min(...l),state.maxYear=Math.max(...l),state.startYear=state.minYear,state.endYear=state.maxYear),document.getElementById("loading").classList.add("hidden"),document.getElementById("app").classList.remove("hidden"),setTimeout(()=>{updateCoralTypeStatus(),updateFilters(),applyFilters(),updateUI(),state.map?(console.log("Updating existing map..."),updateMap()):(console.log("Initializing new map..."),initMap())},300)}catch(s){console.error("ERROR fetching data:",s),alert("Error loading data: "+s.message),document.getElementById("loading").classList.add("hidden"),document.getElementById("app").classList.remove("hidden")}}function updateCoralTypeStatus(){let e=document.getElementById("coral-type-status");if(0===state.selectedOrders.length)e.textContent="⚠️ Please select at least one coral type",e.className="mt-3 text-sm text-red-600";else{let t={Scleractinia:"Hard Corals",Alcyonacea:"Soft Corals",Antipatharia:"Black Corals"},a=state.selectedOrders.map(e=>t[e]).join(", ");e.textContent=`Showing: ${a} (${state.allData.length} total records)`,e.className="mt-3 text-sm text-gray-600"}}function applyFilters(){console.log("Applying filters...");let e=[...state.allData];if(e=e.filter(e=>e.date_year?e.date_year>=state.startYear&&e.date_year<=state.endYear:state.showUndated),"all"!==state.selectedFamily&&(e=e.filter(e=>e.family===state.selectedFamily)),"all"!==state.selectedSpecies&&(e=e.filter(e=>e.species===state.selectedSpecies)),state.searchTerm){let t=state.searchTerm.toLowerCase();e=e.filter(e=>(e.scientificName||"").toLowerCase().includes(t)||(e.family||"").toLowerCase().includes(t)||(e.locality||"").toLowerCase().includes(t))}state.filteredData=e,console.log(`Filtered to ${e.length} records`),state.map&&updateMap(),updateStats(),updateDepthChart()}function updateFilters(){console.log("Updating filters with",state.allData.length,"records");let e=[...new Set(state.allData.map(e=>e.family).filter(Boolean))].sort();console.log("Found families:",e.length);let t=document.getElementById("family-select");t.innerHTML='<option value="all">All Families</option>',e.forEach(e=>{let a=document.createElement("option");a.value=e,a.textContent=e,t.appendChild(a)}),document.getElementById("family-count").textContent=e.length,state.selectedFamily="all",state.selectedSpecies="all",t.value="all";let a=document.getElementById("species-select");a.value="all",a.disabled=!0,a.innerHTML='<option value="all">All Species</option>'}function updateSpeciesFilter(){let e=document.getElementById("species-select");if("all"===state.selectedFamily){e.disabled=!0,e.innerHTML='<option value="all">All Species</option>';return}e.disabled=!1;let t=[...new Set(state.allData.filter(e=>e.family===state.selectedFamily).map(e=>e.species).filter(Boolean))].sort();e.innerHTML='<option value="all">All Species</option>',t.forEach(t=>{let a=document.createElement("option");a.value=t,a.textContent=t,e.appendChild(a)})}function updateStats(){let e=new Set(state.filteredData.map(e=>e.species).filter(Boolean)),t=new Set(state.filteredData.map(e=>e.family).filter(Boolean)),a=state.allData.filter(e=>!e.date_year).length;document.getElementById("stat-total").textContent=state.allData.length.toLocaleString(),document.getElementById("stat-filtered").textContent=`${state.filteredData.length} / ${state.allData.length}`,document.getElementById("stat-species").textContent=e.size,document.getElementById("stat-families").textContent=t.size,document.getElementById("undated-count").textContent=a;let l="all"!==state.selectedFamily||"all"!==state.selectedSpecies||state.searchTerm,s=document.getElementById("filter-summary");l?(s.classList.remove("hidden"),document.getElementById("filter-count").textContent=`Showing ${state.filteredData.length} of ${state.allData.length} observations`):s.classList.add("hidden")}function updateDepthChart(){let e=document.getElementById("depth-chart");e.innerHTML="",[{range:"0-20m",min:0,max:20,color:"#3b82f6"},{range:"20-50m",min:20,max:50,color:"#8b5cf6"},{range:"50-100m",min:50,max:100,color:"#ec4899"},{range:"100m+",min:100,max:1e4,color:"#ef4444"}].forEach(({range:t,min:a,max:l,color:s})=>{let r=state.filteredData.filter(e=>e.depth>=a&&e.depth<l).length,n=state.filteredData.length>0?r/state.filteredData.length*100:0,i=document.createElement("div");i.className="flex-1 flex flex-col items-center",i.innerHTML=`
            <div class="w-full rounded-t transition-all hover:opacity-80" 
                 style="background-color: ${s}; height: ${n}%; min-height: 4px;"></div>
            <p class="text-xs text-gray-600 mt-2">${t}</p>
            <p class="text-sm font-semibold text-gray-800">${r}</p>
        `,e.appendChild(i)})}function updateUI(){document.getElementById("start-year-display").textContent=state.startYear,document.getElementById("end-year-display").textContent=state.endYear,document.getElementById("start-year-label").textContent=state.startYear,document.getElementById("end-year-label").textContent=state.endYear,document.getElementById("min-year").textContent=state.minYear,document.getElementById("max-year").textContent=state.maxYear,document.getElementById("start-year-slider").min=state.minYear,document.getElementById("start-year-slider").max=state.maxYear,document.getElementById("start-year-slider").value=state.startYear,document.getElementById("end-year-slider").min=state.minYear,document.getElementById("end-year-slider").max=state.maxYear,document.getElementById("end-year-slider").value=state.endYear,document.getElementById("year-range-text").textContent=`Showing observations from ${state.startYear} to ${state.endYear}`}function initMap(){console.log("Initializing map...");let e=document.getElementById("map");console.log("Map container dimensions:",e.offsetWidth,"x",e.offsetHeight),(0===e.offsetWidth||0===e.offsetHeight)&&console.error("Map container has zero dimensions!"),state.map=L.map("map",{attributionControl:!1,center:[20,0],zoom:2,minZoom:2,maxZoom:19,worldCopyJump:!0}),console.log("Map created with center:",state.map.getCenter(),"zoom:",state.map.getZoom()),L.control.attribution({prefix:""}).addTo(state.map),state.baseLayer=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"\xa9 OpenStreetMap contributors",maxZoom:19}).addTo(state.map),setTimeout(()=>{console.log("Invalidating map size..."),state.map.invalidateSize(),state.map.setView([20,0],2),console.log("Map view reset to:",state.map.getCenter(),"zoom:",state.map.getZoom()),addMarkersAndFitBounds()},100),console.log("Map initialized")}function updateMap(){if(!state.map){initMap();return}addMarkersAndFitBounds()}function addMarkersAndFitBounds(){if(console.log("Updating map..."),state.markers.forEach(e=>e.remove()),state.markers=[],state.layers.observations){if(console.log(`Adding ${state.filteredData.length} observation markers`),state.filteredData.forEach(e=>{if(!e.decimalLatitude||!e.decimalLongitude)return;let t=getDepthColor(e.depth),a=L.circleMarker([e.decimalLatitude,e.decimalLongitude],{radius:6,fillColor:t,color:"#fff",weight:2,opacity:1,fillOpacity:.7}).addTo(state.map);a.on("click",()=>showDetails(e));let l=`
                <div style="min-width: 200px;">
                    <strong>${e.scientificName||"Unknown"}</strong><br/>
                    <em>${e.family||"N/A"}</em><br/>
                    Depth: ${e.depth?e.depth+"m":"N/A"}<br/>
                    ${e.locality||""}
                </div>
            `;a.bindPopup(l),state.markers.push(a)}),state.markers.length>0)try{let e=L.featureGroup(state.markers),t=e.getBounds();t.isValid()?(state.map.fitBounds(t,{padding:[50,50],maxZoom:6}),console.log("Map fitted to bounds")):(console.warn("Invalid bounds, using default view"),state.map.setView([20,0],2))}catch(a){console.error("Error fitting bounds:",a),state.map.setView([20,0],2)}else state.map.setView([20,0],2)}else state.map.setView([20,0],2);updateLayers()}function updateLayers(){if(state.map){if(console.log("Updating layers:",state.layers),state.layers.basemap&&!state.map.hasLayer(state.baseLayer)?state.baseLayer.addTo(state.map):!state.layers.basemap&&state.map.hasLayer(state.baseLayer)&&state.map.removeLayer(state.baseLayer),state.layers.reefs&&!state.layerGroups.reefs){console.log("Adding reef boundaries layer..."),document.getElementById("reef-status").classList.remove("hidden"),document.getElementById("reef-debug-info").innerHTML="Loading reef layer...",addFallbackReefs(),state.map.getPane("reefPane")||(state.map.createPane("reefPane"),state.map.getPane("reefPane").style.zIndex=650);let e={layers:"coral-atlas:geomorphic_data_verbose",format:"image/png",transparent:!0,version:"1.3.0",crs:L.CRS.EPSG4326,attribution:"\xa9 Allen Coral Atlas",opacity:.9,pane:"reefPane",minZoom:8,maxZoom:19,tileSize:256};try{state.layerGroups.reefs=L.tileLayer.wms("https://allencoralatlas.org/geoserver/ows",e),state.layerGroups.reefs.on("loading",()=>{document.getElementById("reef-debug-info").innerHTML="Fallback reef areas shown. <strong>Zoom in (level 8+) to see detailed reef boundaries.</strong>"}),state.layerGroups.reefs.on("load",()=>{document.getElementById("reef-debug-info").innerHTML="✓ Detailed reef boundaries visible at this zoom level."}),state.layerGroups.reefs.on("tileerror",e=>{console.error("WMS tile error:",e.tile.src),document.getElementById("reef-debug-info").innerHTML="⚠️ Detailed WMS tiles unavailable. Showing approximate reef locations."}),state.layerGroups.reefs.addTo(state.map);let t=state.map.getPane("reefPane");t.style.filter="hue-rotate(200deg) saturate(4) brightness(2) contrast(2)",t.style.mixBlendMode="multiply",console.log("Reef WMS layer added (visible at zoom 8+)")}catch(a){console.error("Error creating WMS layer:",a),document.getElementById("reef-debug-info").innerHTML="⚠️ Using fallback visualization only."}}else!state.layers.reefs&&state.layerGroups.reefs&&(console.log("Removing reef layers"),state.layerGroups.reefs&&(state.map.removeLayer(state.layerGroups.reefs),state.layerGroups.reefs=null),state.layerGroups.reefsFallback&&(state.map.removeLayer(state.layerGroups.reefsFallback),state.layerGroups.reefsFallback=null),document.getElementById("reef-status").classList.add("hidden"));state.layers.temperature&&!state.layerGroups.temperature?(console.log("Adding temperature layer..."),state.layerGroups.temperature=L.layerGroup(),[{lat:-18,lon:147,intensity:.8,temp:"+2.5\xb0C"},{lat:10,lon:-80,intensity:.6,temp:"+1.8\xb0C"},{lat:-8,lon:115,intensity:.9,temp:"+3.1\xb0C"},{lat:20,lon:-157,intensity:.5,temp:"+1.2\xb0C"},{lat:5,lon:120,intensity:.7,temp:"+2.0\xb0C"}].forEach(e=>{let t=e.intensity>.7?"#ff0000":e.intensity>.5?"#ff6600":"#ffaa00";L.circle([e.lat,e.lon],{radius:2e5,color:t,fillColor:t,fillOpacity:.3,weight:1}).addTo(state.layerGroups.temperature).bindPopup(`<b>Temperature Anomaly:</b> ${e.temp}`)}),state.layerGroups.temperature.addTo(state.map),console.log("Temperature layer added")):!state.layers.temperature&&state.layerGroups.temperature&&(console.log("Removing temperature layer"),state.map.removeLayer(state.layerGroups.temperature),state.layerGroups.temperature=null),updateLegend()}}function addFallbackReefs(){console.log("Adding fallback reef visualization"),!state.layerGroups.reefsFallback&&(state.layerGroups.reefsFallback=L.layerGroup(),[{name:"Great Barrier Reef",bounds:[[-24,145],[-10,154]],color:"#00FFFF"},{name:"Caribbean Reef System",bounds:[[10,-85],[25,-60]],color:"#00FFFF"},{name:"Red Sea Reefs",bounds:[[12,36],[28,43]],color:"#00FFFF"},{name:"Coral Triangle",bounds:[[-10,95],[20,140]],color:"#00FFFF"},{name:"Maldives Reefs",bounds:[[-1,72],[8,74]],color:"#00FFFF"},{name:"Hawaiian Reefs",bounds:[[18,-161],[23,-154]],color:"#00FFFF"},{name:"Florida Keys",bounds:[[24,-82],[26,-80]],color:"#00FFFF"}].forEach(e=>{L.rectangle(e.bounds,{color:e.color,weight:3,fillColor:e.color,fillOpacity:.3,dashArray:"5, 5"}).addTo(state.layerGroups.reefsFallback).bindPopup(`<b>${e.name}</b><br><em>Approximate reef area</em>`)}),state.layerGroups.reefsFallback.addTo(state.map),document.getElementById("reef-debug-info").innerHTML="⚠️ Using fallback visualization. Showing approximate major reef locations in bright cyan.")}function updateLegend(){let e=document.getElementById("layer-legend"),t=document.getElementById("legend-items"),a=state.layers.reefs||state.layers.temperature;a?(e.classList.remove("hidden"),t.innerHTML="",state.layers.reefs&&(t.innerHTML+=`
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 border-2 border-cyan-400 bg-cyan-200"></div>
                    <span>Reef Boundaries (Cyan rectangles = approximate areas; detailed at zoom 8+)</span>
                </div>
            `),state.layers.temperature&&(t.innerHTML+=`
                <div class="flex items-center gap-2">
                    <div class="flex gap-1">
                        <div class="w-3 h-4 bg-yellow-400 rounded"></div>
                        <div class="w-3 h-4 bg-orange-500 rounded"></div>
                        <div class="w-3 h-4 bg-red-600 rounded"></div>
                    </div>
                    <span>Heat Stress (Low → High)</span>
                </div>
            `)):e.classList.add("hidden")}function showDetails(e){let t=document.getElementById("details-panel");t.innerHTML=`
        <div class="space-y-3 text-sm">
            <div>
                <p class="font-semibold text-gray-700">Species</p>
                <p class="text-gray-600 italic">${e.scientificName||"N/A"}</p>
            </div>
            <div>
                <p class="font-semibold text-gray-700">Family</p>
                <p class="text-gray-600">${e.family||"N/A"}</p>
            </div>
            <div>
                <p class="font-semibold text-gray-700">Location</p>
                <p class="text-gray-600">${e.locality||"N/A"}</p>
            </div>
            <div>
                <p class="font-semibold text-gray-700">Coordinates</p>
                <p class="text-gray-600">${e.decimalLatitude?.toFixed(4)}\xb0, ${e.decimalLongitude?.toFixed(4)}\xb0</p>
            </div>
            <div>
                <p class="font-semibold text-gray-700">Depth</p>
                <p class="text-gray-600">${e.depth?e.depth+"m":"N/A"}</p>
            </div>
            <div>
                <p class="font-semibold text-gray-700">Date</p>
                <p class="text-gray-600">${e.eventDate||"N/A"}</p>
            </div>
            ${e.sst?`
                <div>
                    <p class="font-semibold text-gray-700">Sea Surface Temp</p>
                    <p class="text-gray-600">${e.sst}\xb0C</p>
                </div>
            `:""}
        </div>
    `}function togglePlayPause(){state.isPlaying=!state.isPlaying;let e=document.getElementById("play-pause");state.isPlaying?(e.textContent="⏸️ Pause",state.endYear>=state.maxYear&&(state.endYear=state.startYear),playTimeline()):(e.textContent="▶️ Play",state.playInterval&&(clearInterval(state.playInterval),state.playInterval=null))}function playTimeline(){let e=parseInt(document.getElementById("play-speed").value);state.playInterval=setInterval(()=>{if(state.endYear>=state.maxYear){togglePlayPause();return}state.endYear++,document.getElementById("end-year-slider").value=state.endYear,updateUI(),applyFilters()},e)}function resetTimeline(){state.startYear=state.minYear,state.endYear=state.maxYear,state.isPlaying=!1,state.playInterval&&(clearInterval(state.playInterval),state.playInterval=null),document.getElementById("play-pause").textContent="▶️ Play",updateUI(),applyFilters()}function setupEventListeners(){let e=[document.getElementById("coral-type-scleractinia"),document.getElementById("coral-type-alcyonacea"),document.getElementById("coral-type-antipatharia")];e.forEach(t=>{t.addEventListener("change",()=>{state.selectedOrders=e.filter(e=>e.checked).map(e=>e.value),console.log("Selected coral types:",state.selectedOrders),e.forEach(e=>{let t=e.closest("label");e.checked?(t.classList.add("border-blue-500","bg-blue-50"),t.classList.remove("border-gray-200")):(t.classList.remove("border-blue-500","bg-blue-50"),t.classList.add("border-gray-200"))}),state.selectedOrders.length>0?fetchCoralData():updateCoralTypeStatus()})}),document.getElementById("layer-basemap").addEventListener("change",e=>{state.layers.basemap=e.target.checked,updateLayers()}),document.getElementById("layer-observations").addEventListener("change",e=>{state.layers.observations=e.target.checked,updateMap()}),document.getElementById("layer-reefs").addEventListener("change",e=>{state.layers.reefs=e.target.checked,console.log("Reefs layer:",state.layers.reefs),updateLayers()}),document.getElementById("layer-temperature").addEventListener("change",e=>{state.layers.temperature=e.target.checked,console.log("Temperature layer:",state.layers.temperature),updateLayers()}),document.getElementById("search-input").addEventListener("input",e=>{state.searchTerm=e.target.value,applyFilters()}),document.getElementById("family-select").addEventListener("change",e=>{state.selectedFamily=e.target.value,state.selectedSpecies="all",updateSpeciesFilter(),applyFilters()}),document.getElementById("species-select").addEventListener("change",e=>{state.selectedSpecies=e.target.value,applyFilters()}),document.getElementById("clear-filters").addEventListener("click",()=>{state.selectedFamily="all",state.selectedSpecies="all",state.searchTerm="",document.getElementById("family-select").value="all",document.getElementById("species-select").value="all",document.getElementById("search-input").value="",updateSpeciesFilter(),applyFilters()}),document.getElementById("start-year-slider").addEventListener("input",e=>{state.startYear=parseInt(e.target.value),state.startYear>state.endYear&&(state.endYear=state.startYear,document.getElementById("end-year-slider").value=state.endYear),updateUI(),applyFilters()}),document.getElementById("end-year-slider").addEventListener("input",e=>{state.endYear=parseInt(e.target.value),state.endYear<state.startYear&&(state.startYear=state.endYear,document.getElementById("start-year-slider").value=state.startYear),updateUI(),applyFilters()}),document.getElementById("show-undated").addEventListener("change",e=>{state.showUndated=e.target.checked,applyFilters()}),document.getElementById("play-pause").addEventListener("click",togglePlayPause),document.getElementById("reset-timeline").addEventListener("click",resetTimeline)}document.addEventListener("DOMContentLoaded",()=>{console.log("App starting..."),state.selectedOrders=[];let e=[document.getElementById("coral-type-scleractinia"),document.getElementById("coral-type-alcyonacea"),document.getElementById("coral-type-antipatharia")];e.forEach(e=>{e&&e.checked&&state.selectedOrders.push(e.value)}),console.log("Initial selected orders:",state.selectedOrders),setupEventListeners(),fetchCoralData()});
