const state={allData:[],filteredData:[],selectedOrder:"Scleractinia",searchTerm:"",selectedFamily:"all",selectedSpecies:"all",startYear:1900,endYear:2024,minYear:1900,maxYear:2024,showUndated:!0,isPlaying:!1,playInterval:null,layers:{basemap:!0,observations:!0,reefs:!1,mpas:!1,temperature:!1},map:null,baseLayer:null,markers:[],layerGroups:{observations:null,reefs:null,reefsFallback:null,mpas:null,temperature:null}};function getDepthColor(e){return e?e<20?"#3b82f6":e<50?"#8b5cf6":e<100?"#ec4899":"#ef4444":"#94a3b8"}async function fetchCoralData(){try{let e=await fetch(`https://api.obis.org/v3/occurrence?scientificname=${state.selectedOrder}&size=500`),t=await e.json();state.allData=t.results||[];let a=state.allData.map(e=>e.date_year).filter(Boolean);a.length>0&&(state.minYear=Math.min(...a),state.maxYear=Math.max(...a),state.startYear=state.minYear,state.endYear=state.maxYear),document.getElementById("loading").classList.add("hidden"),document.getElementById("app").classList.remove("hidden"),setTimeout(()=>{updateFilters(),applyFilters(),updateUI(),initMap()},300)}catch(s){console.error("Error fetching data:",s),alert("Error loading data: "+s.message)}}function applyFilters(){let e=[...state.allData];if(e=e.filter(e=>e.date_year?e.date_year>=state.startYear&&e.date_year<=state.endYear:state.showUndated),"all"!==state.selectedFamily&&(e=e.filter(e=>e.family===state.selectedFamily)),"all"!==state.selectedSpecies&&(e=e.filter(e=>e.species===state.selectedSpecies)),state.searchTerm){let t=state.searchTerm.toLowerCase();e=e.filter(e=>(e.scientificName||"").toLowerCase().includes(t)||(e.family||"").toLowerCase().includes(t)||(e.locality||"").toLowerCase().includes(t))}state.filteredData=e,updateMap(),updateStats(),updateDepthChart()}function updateFilters(){let e=[...new Set(state.allData.map(e=>e.family).filter(Boolean))].sort(),t=document.getElementById("family-select");t.innerHTML='<option value="all">All Families</option>',e.forEach(e=>{let a=document.createElement("option");a.value=e,a.textContent=e,t.appendChild(a)}),document.getElementById("family-count").textContent=e.length}function updateSpeciesFilter(){let e=document.getElementById("species-select");if("all"===state.selectedFamily){e.disabled=!0,e.innerHTML='<option value="all">All Species</option>';return}e.disabled=!1;let t=[...new Set(state.allData.filter(e=>e.family===state.selectedFamily).map(e=>e.species).filter(Boolean))].sort();e.innerHTML='<option value="all">All Species</option>',t.forEach(t=>{let a=document.createElement("option");a.value=t,a.textContent=t,e.appendChild(a)})}function updateStats(){let e=new Set(state.filteredData.map(e=>e.species).filter(Boolean)),t=new Set(state.filteredData.map(e=>e.family).filter(Boolean)),a=state.allData.filter(e=>!e.date_year).length;document.getElementById("stat-total").textContent=state.allData.length.toLocaleString(),document.getElementById("stat-filtered").textContent=`${state.filteredData.length} / ${state.allData.length}`,document.getElementById("stat-species").textContent=e.size,document.getElementById("stat-families").textContent=t.size,document.getElementById("undated-count").textContent=a;let s="all"!==state.selectedFamily||"all"!==state.selectedSpecies||state.searchTerm,r=document.getElementById("filter-summary");s?(r.classList.remove("hidden"),document.getElementById("filter-count").textContent=`Showing ${state.filteredData.length} of ${state.allData.length} observations`):r.classList.add("hidden")}function updateDepthChart(){let e=document.getElementById("depth-chart");e.innerHTML="",[{range:"0-20m",min:0,max:20,color:"#3b82f6"},{range:"20-50m",min:20,max:50,color:"#8b5cf6"},{range:"50-100m",min:50,max:100,color:"#ec4899"},{range:"100m+",min:100,max:1e4,color:"#ef4444"}].forEach(({range:t,min:a,max:s,color:r})=>{let l=state.filteredData.filter(e=>e.depth>=a&&e.depth<s).length,n=state.filteredData.length>0?l/state.filteredData.length*100:0,i=document.createElement("div");i.className="flex-1 flex flex-col items-center",i.innerHTML=`
            <div class="w-full rounded-t transition-all hover:opacity-80" 
                 style="background-color: ${r}; height: ${n}%; min-height: 4px;"></div>
            <p class="text-xs text-gray-600 mt-2">${t}</p>
            <p class="text-sm font-semibold text-gray-800">${l}</p>
        `,e.appendChild(i)})}function updateUI(){document.getElementById("start-year-display").textContent=state.startYear,document.getElementById("end-year-display").textContent=state.endYear,document.getElementById("start-year-label").textContent=state.startYear,document.getElementById("end-year-label").textContent=state.endYear,document.getElementById("min-year").textContent=state.minYear,document.getElementById("max-year").textContent=state.maxYear,document.getElementById("start-year-slider").min=state.minYear,document.getElementById("start-year-slider").max=state.maxYear,document.getElementById("start-year-slider").value=state.startYear,document.getElementById("end-year-slider").min=state.minYear,document.getElementById("end-year-slider").max=state.maxYear,document.getElementById("end-year-slider").value=state.endYear,document.getElementById("year-range-text").textContent=`Showing observations from ${state.startYear} to ${state.endYear}`}function initMap(){let e=document.getElementById("map");(0===e.offsetWidth||0===e.offsetHeight)&&console.error("Map container has zero dimensions!"),state.map=L.map("map",{attributionControl:!1,center:[20,0],zoom:2,minZoom:2,maxZoom:19,worldCopyJump:!0}),L.control.attribution({prefix:""}).addTo(state.map),state.baseLayer=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"\xa9 OpenStreetMap contributors",maxZoom:19}).addTo(state.map),setTimeout(()=>{state.map.invalidateSize(),state.map.setView([20,0],2)},100)}function updateMap(){if(!state.map){initMap(),setTimeout(()=>{addMarkersAndFitBounds()},200);return}addMarkersAndFitBounds()}function addMarkersAndFitBounds(){if(state.markers.forEach(e=>e.remove()),state.markers=[],state.layers.observations){if(state.filteredData.forEach(e=>{if(!e.decimalLatitude||!e.decimalLongitude)return;let t=getDepthColor(e.depth),a=L.circleMarker([e.decimalLatitude,e.decimalLongitude],{radius:6,fillColor:t,color:"#fff",weight:2,opacity:1,fillOpacity:.7}).addTo(state.map);a.on("click",()=>showDetails(e));let s=`
                <div style="min-width: 200px;">
                    <strong>${e.scientificName||"Unknown"}</strong><br/>
                    <em>${e.family||"N/A"}</em><br/>
                    Depth: ${e.depth?e.depth+"m":"N/A"}<br/>
                    ${e.locality||""}
                </div>
            `;a.bindPopup(s),state.markers.push(a)}),state.markers.length>0)try{let e=L.featureGroup(state.markers),t=e.getBounds();t.isValid()?state.map.fitBounds(t,{padding:[50,50],maxZoom:6}):(console.warn("Invalid bounds, using default view"),state.map.setView([20,0],2))}catch(a){console.error("Error fitting bounds:",a),state.map.setView([20,0],2)}else state.map.setView([20,0],2)}else state.map.setView([20,0],2);updateLayers()}function updateLayers(){if(state.map){if(state.layers.basemap&&!state.map.hasLayer(state.baseLayer)?state.baseLayer.addTo(state.map):!state.layers.basemap&&state.map.hasLayer(state.baseLayer)&&state.map.removeLayer(state.baseLayer),state.layers.reefs&&!state.layerGroups.reefs){document.getElementById("reef-status").classList.remove("hidden"),document.getElementById("reef-debug-info").innerHTML="Loading reef layer...",state.map.getPane("reefPane")||(state.map.createPane("reefPane"),state.map.getPane("reefPane").style.zIndex=650);let e={layers:"coral-atlas:geomorphic_data_verbose",format:"image/png",transparent:!0,version:"1.3.0",crs:L.CRS.EPSG4326,attribution:"\xa9 Allen Coral Atlas",opacity:.9,pane:"reefPane",maxZoom:19,tileSize:256};try{state.layerGroups.reefs=L.tileLayer.wms("https://allencoralatlas.org/geoserver/ows",e),state.layerGroups.reefs.on("loading",()=>{document.getElementById("reef-debug-info").innerHTML="Loading tiles from Allen Coral Atlas..."}),state.layerGroups.reefs.on("load",()=>{document.getElementById("reef-debug-info").innerHTML="✓ Reef layer loaded. <strong>Zoom in close to reef areas to see details.</strong> Try GBR (Australia east coast)."}),state.layerGroups.reefs.on("tileerror",e=>{console.error("WMS tile error details:",e),document.getElementById("reef-debug-info").innerHTML=`✗ Tile loading error. Trying alternate configuration... <br><small>${e.tile.src}</small>`,state.layerGroups.reefs._fallbackAdded||(addFallbackReefs(),state.layerGroups.reefs._fallbackAdded=!0)}),state.layerGroups.reefs.addTo(state.map);let t=state.map.getPane("reefPane");t.style.filter="hue-rotate(200deg) saturate(4) brightness(2) contrast(2)",t.style.mixBlendMode="multiply"}catch(a){console.error("Error creating WMS layer:",a),document.getElementById("reef-debug-info").innerHTML="✗ Failed to create WMS layer. Using fallback visualization.",addFallbackReefs()}}else!state.layers.reefs&&state.layerGroups.reefs&&(state.map.removeLayer(state.layerGroups.reefs),state.layerGroups.reefs=null,state.layerGroups.reefsFallback&&(state.map.removeLayer(state.layerGroups.reefsFallback),state.layerGroups.reefsFallback=null),document.getElementById("reef-status").classList.add("hidden"));state.layers.mpas&&!state.layerGroups.mpas?(state.layerGroups.mpas=L.layerGroup(),[{name:"Great Barrier Reef Marine Park",lat:-18,lon:147,radius:15e4},{name:"Papahānaumokuākea",lat:25,lon:-170,radius:2e5},{name:"Phoenix Islands Protected Area",lat:-3,lon:-171,radius:15e4},{name:"Coral Sea Marine Park",lat:-17,lon:155,radius:1e5},{name:"Maldives MPA",lat:3,lon:73,radius:5e4}].forEach(e=>{L.circle([e.lat,e.lon],{radius:e.radius,color:"#4169E1",fillColor:"#4169E1",fillOpacity:.15,weight:2}).addTo(state.layerGroups.mpas).bindPopup(`<b>MPA:</b> ${e.name}`)}),state.layerGroups.mpas.addTo(state.map)):!state.layers.mpas&&state.layerGroups.mpas&&(state.map.removeLayer(state.layerGroups.mpas),state.layerGroups.mpas=null),state.layers.temperature&&!state.layerGroups.temperature?(state.layerGroups.temperature=L.layerGroup(),[{lat:-18,lon:147,intensity:.8,temp:"+2.5\xb0C"},{lat:10,lon:-80,intensity:.6,temp:"+1.8\xb0C"},{lat:-8,lon:115,intensity:.9,temp:"+3.1\xb0C"},{lat:20,lon:-157,intensity:.5,temp:"+1.2\xb0C"},{lat:5,lon:120,intensity:.7,temp:"+2.0\xb0C"}].forEach(e=>{let t=e.intensity>.7?"#ff0000":e.intensity>.5?"#ff6600":"#ffaa00";L.circle([e.lat,e.lon],{radius:2e5,color:t,fillColor:t,fillOpacity:.3,weight:1}).addTo(state.layerGroups.temperature).bindPopup(`<b>Temperature Anomaly:</b> ${e.temp}`)}),state.layerGroups.temperature.addTo(state.map)):!state.layers.temperature&&state.layerGroups.temperature&&(state.map.removeLayer(state.layerGroups.temperature),state.layerGroups.temperature=null),updateLegend()}}function addFallbackReefs(){!state.layerGroups.reefsFallback&&(state.layerGroups.reefsFallback=L.layerGroup(),[{name:"Great Barrier Reef",bounds:[[-24,145],[-10,154]],color:"#00FFFF"},{name:"Caribbean Reef System",bounds:[[10,-85],[25,-60]],color:"#00FFFF"},{name:"Red Sea Reefs",bounds:[[12,36],[28,43]],color:"#00FFFF"},{name:"Coral Triangle",bounds:[[-10,95],[20,140]],color:"#00FFFF"},{name:"Maldives Reefs",bounds:[[-1,72],[8,74]],color:"#00FFFF"},{name:"Hawaiian Reefs",bounds:[[18,-161],[23,-154]],color:"#00FFFF"},{name:"Florida Keys",bounds:[[24,-82],[26,-80]],color:"#00FFFF"}].forEach(e=>{L.rectangle(e.bounds,{color:e.color,weight:3,fillColor:e.color,fillOpacity:.3,dashArray:"5, 5"}).addTo(state.layerGroups.reefsFallback).bindPopup(`<b>${e.name}</b><br><em>Approximate reef area</em>`)}),state.layerGroups.reefsFallback.addTo(state.map),document.getElementById("reef-debug-info").innerHTML="⚠️ Using fallback visualization. Showing approximate major reef locations in bright cyan.")}function updateLegend(){let e=document.getElementById("layer-legend"),t=document.getElementById("legend-items"),a=state.layers.reefs||state.layers.mpas||state.layers.temperature;a?(e.classList.remove("hidden"),t.innerHTML="",state.layers.reefs&&(t.innerHTML+=`
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 border-2 border-cyan-400 bg-cyan-200"></div>
                    <span>Reef Boundaries (Bright Cyan)</span>
                </div>
            `),state.layers.mpas&&(t.innerHTML+=`
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full border-2 border-blue-500 bg-blue-100"></div>
                    <span>Marine Protected Areas</span>
                </div>
            `),state.layers.temperature&&(t.innerHTML+=`
                <div class="flex items-center gap-2">
                    <div class="flex gap-1">
                        <div class="w-3 h-4 bg-yellow-400 rounded"></div>
                        <div class="w-3 h-4 bg-orange-500 rounded"></div>
                        <div class="w-3 h-4 bg-red-600 rounded"></div>
                    </div>
                    <span>Heat Stress (Low → High)</span>
                </div>
            `)):e.classList.add("hidden")}function showDetails(e){let t=document.getElementById("details-panel");t.innerHTML=`
        <div class="space-y-3 text-sm">
            <div>
                <p class="font-semibold text-gray-700">Species</p>
                <p class="text-gray-600 italic">${e.scientificName||"N/A"}</p>
            </div>
            <div>
                <p class="font-semibold text-gray-700">Family</p>
                <p class="text-gray-600">${e.family||"N/A"}</p>
            </div>
            <div>
                <p class="font-semibold text-gray-700">Location</p>
                <p class="text-gray-600">${e.locality||"N/A"}</p>
            </div>
            <div>
                <p class="font-semibold text-gray-700">Coordinates</p>
                <p class="text-gray-600">${e.decimalLatitude?.toFixed(4)}\xb0, ${e.decimalLongitude?.toFixed(4)}\xb0</p>
            </div>
            <div>
                <p class="font-semibold text-gray-700">Depth</p>
                <p class="text-gray-600">${e.depth?e.depth+"m":"N/A"}</p>
            </div>
            <div>
                <p class="font-semibold text-gray-700">Date</p>
                <p class="text-gray-600">${e.eventDate||"N/A"}</p>
            </div>
            ${e.sst?`
                <div>
                    <p class="font-semibold text-gray-700">Sea Surface Temp</p>
                    <p class="text-gray-600">${e.sst}\xb0C</p>
                </div>
            `:""}
        </div>
    `}function togglePlayPause(){state.isPlaying=!state.isPlaying;let e=document.getElementById("play-pause");state.isPlaying?(e.textContent="⏸️ Pause",state.endYear>=state.maxYear&&(state.endYear=state.startYear),playTimeline()):(e.textContent="▶️ Play",state.playInterval&&(clearInterval(state.playInterval),state.playInterval=null))}function playTimeline(){let e=parseInt(document.getElementById("play-speed").value);state.playInterval=setInterval(()=>{if(state.endYear>=state.maxYear){togglePlayPause();return}state.endYear++,document.getElementById("end-year-slider").value=state.endYear,updateUI(),applyFilters()},e)}function resetTimeline(){state.startYear=state.minYear,state.endYear=state.maxYear,state.isPlaying=!1,state.playInterval&&(clearInterval(state.playInterval),state.playInterval=null),document.getElementById("play-pause").textContent="▶️ Play",updateUI(),applyFilters()}function setupEventListeners(){document.querySelectorAll(".coral-type-btn").forEach(e=>{e.addEventListener("click",()=>{state.selectedOrder=e.dataset.order,document.querySelectorAll(".coral-type-btn").forEach(e=>{e.classList.remove("border-blue-500","bg-blue-50"),e.classList.add("border-gray-200")}),e.classList.add("border-blue-500","bg-blue-50"),e.classList.remove("border-gray-200"),fetchCoralData()})}),document.getElementById("layer-basemap").addEventListener("change",e=>{state.layers.basemap=e.target.checked,updateLayers()}),document.getElementById("layer-observations").addEventListener("change",e=>{state.layers.observations=e.target.checked,updateMap()}),document.getElementById("layer-reefs").addEventListener("change",e=>{state.layers.reefs=e.target.checked,updateLayers()}),document.getElementById("layer-mpas").addEventListener("change",e=>{state.layers.mpas=e.target.checked,updateLayers()}),document.getElementById("layer-temperature").addEventListener("change",e=>{state.layers.temperature=e.target.checked,updateLayers()}),document.getElementById("search-input").addEventListener("input",e=>{state.searchTerm=e.target.value,applyFilters()}),document.getElementById("family-select").addEventListener("change",e=>{state.selectedFamily=e.target.value,state.selectedSpecies="all",updateSpeciesFilter(),applyFilters()}),document.getElementById("species-select").addEventListener("change",e=>{state.selectedSpecies=e.target.value,applyFilters()}),document.getElementById("clear-filters").addEventListener("click",()=>{state.selectedFamily="all",state.selectedSpecies="all",state.searchTerm="",document.getElementById("family-select").value="all",document.getElementById("species-select").value="all",document.getElementById("search-input").value="",updateSpeciesFilter(),applyFilters()}),document.getElementById("start-year-slider").addEventListener("input",e=>{state.startYear=parseInt(e.target.value),state.startYear>state.endYear&&(state.endYear=state.startYear,document.getElementById("end-year-slider").value=state.endYear),updateUI(),applyFilters()}),document.getElementById("end-year-slider").addEventListener("input",e=>{state.endYear=parseInt(e.target.value),state.endYear<state.startYear&&(state.startYear=state.endYear,document.getElementById("start-year-slider").value=state.startYear),updateUI(),applyFilters()}),document.getElementById("show-undated").addEventListener("change",e=>{state.showUndated=e.target.checked,applyFilters()}),document.getElementById("play-pause").addEventListener("click",togglePlayPause),document.getElementById("reset-timeline").addEventListener("click",resetTimeline)}document.addEventListener("DOMContentLoaded",()=>{setupEventListeners(),fetchCoralData()});
